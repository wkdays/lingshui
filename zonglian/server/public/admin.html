<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é™µæ°´æ•°æŠ• - ç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fb; min-height: 100vh; }
    
    /* ç™»å½•é¡µæ ·å¼ */
    .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .login-box { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 380px; }
    .login-logo { text-align: center; margin-bottom: 30px; }
    .login-logo h2 { color: #333; font-size: 22px; margin-bottom: 8px; }
    .login-logo p { color: #999; font-size: 14px; }
    .login-form .form-group { margin-bottom: 20px; }
    .login-form .form-label { display: block; margin-bottom: 8px; font-size: 14px; color: #666; }
    .login-form .form-input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
    .login-form .form-input:focus { outline: none; border-color: #667eea; }
    .login-form .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: opacity 0.2s; }
    .login-form .login-btn:hover { opacity: 0.9; }
    .login-error { color: #ff4d4f; font-size: 13px; margin-top: 10px; text-align: center; display: none; }
    
    /* ä¸»é¡µé¢æ ·å¼ - å·¦ä¾§èœå•å¸ƒå±€ */
    .main-page { display: none; min-height: 100vh; }
    .main-page.show { display: flex; }
    .login-page.hide { display: none; }
    
    /* å·¦ä¾§è¾¹æ  */
    .sidebar { width: 220px; background: #001529; min-height: 100vh; flex-shrink: 0; }
    .sidebar-logo { padding: 20px; text-align: center; border-bottom: 1px solid #0d2137; }
    .sidebar-logo h2 { color: #fff; font-size: 16px; font-weight: 600; }
    .sidebar-logo p { color: #5a7a9a; font-size: 12px; margin-top: 5px; }
    .sidebar-menu { padding: 10px 0; }
    .menu-item { display: flex; align-items: center; padding: 14px 24px; color: #8a9bae; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .menu-item:hover { background: #0d2137; color: #fff; }
    .menu-item.active { background: #1890ff; color: #fff; border-left-color: #1890ff; }
    .menu-icon { width: 18px; margin-right: 12px; font-size: 16px; }
    .menu-text { font-size: 14px; }
    
    /* å³ä¾§å†…å®¹åŒº */
    .main-content { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; }
    .header { background: #fff; padding: 0 24px; height: 64px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .header-left h1 { font-size: 18px; font-weight: 600; color: #333; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 14px; color: #666; }
    .logout-btn { padding: 6px 14px; background: #fff; border: 1px solid #d9d9d9; color: #666; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .logout-btn:hover { color: #1890ff; border-color: #1890ff; }
    .content-area { flex: 1; padding: 24px; overflow-y: auto; }
    .upload-area { border: 2px dashed #d9d9d9; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s; min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .upload-area:hover { border-color: #1890ff; }
    .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 18px; font-weight: 600; color: #1f2430; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #2f6dff; color: #fff; }
    .btn-primary:hover { background: #1a5ae0; }
    .btn-danger { background: #ff4d4f; color: #fff; }
    .btn-danger:hover { background: #d9363e; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; color: #666; }
    tr:hover { background: #f8f9fa; }
    .status { padding: 4px 10px; border-radius: 4px; font-size: 12px; }
    .status-published { background: #e6f7e6; color: #52c41a; }
    .status-draft { background: #fff7e6; color: #faad14; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; border-radius: 12px; padding: 24px; width: 500px; max-width: 90%; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 6px; font-size: 14px; color: #666; }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .form-input:focus { outline: none; border-color: #2f6dff; }
    textarea.form-input { min-height: 100px; resize: vertical; }
    .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .empty { text-align: center; padding: 40px; color: #999; }
    .actions { display: flex; gap: 8px; }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µ -->
  <div id="login-page" class="login-page">
    <div class="login-box">
      <div class="login-logo">
        <h2>é™µæ°´æ•°æŠ•æ•°å­—ç»æµä¾›åº”é“¾</h2>
        <p>ç®¡ç†åå°ç™»å½•</p>
      </div>
      <form class="login-form" id="login-form">
        <div class="form-group">
          <label class="form-label">æ‰‹æœºå·</label>
          <input type="text" class="form-input" id="login-phone" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜æ‰‹æœºå·" required>
        </div>
        <div class="form-group">
          <label class="form-label">å¯†ç </label>
          <input type="password" class="form-input" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit" class="login-btn">ç™» å½•</button>
        <div class="login-error" id="login-error">æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯</div>
      </form>
    </div>
  </div>

  <!-- ä¸»é¡µé¢ -->
  <div id="main-page" class="main-page">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <h2>é™µæ°´æ•°æŠ•</h2>
        <p>æ•°å­—ç»æµä¾›åº”é“¾</p>
      </div>
      <div class="sidebar-menu">
        <div class="menu-item active" onclick="switchMenu('banners', this)">
          <span class="menu-icon">ğŸ“·</span>
          <span class="menu-text">è½®æ’­å›¾ç®¡ç†</span>
        </div>
        <div class="menu-item" onclick="switchMenu('announcements', this)">
          <span class="menu-icon">ğŸ“¢</span>
          <span class="menu-text">å…¬å‘Šç®¡ç†</span>
        </div>
        <div class="menu-item" onclick="switchMenu('tasks', this)">
          <span class="menu-icon">ğŸ“‹</span>
          <span class="menu-text">ä»»åŠ¡ç®¡ç†</span>
        </div>
        <div class="menu-item" onclick="switchMenu('myTasks', this)">
          <span class="menu-icon">ğŸ“Š</span>
          <span class="menu-text">æˆ‘å‘çš„å•</span>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="main-content">
      <div class="header">
        <div class="header-left">
          <h1 id="page-title">è½®æ’­å›¾ç®¡ç†</h1>
        </div>
        <div class="header-right">
          <span class="user-info">ğŸ‘¤ <span id="admin-name">ç®¡ç†å‘˜</span></span>
          <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
      </div>
      
      <div class="content-area">
        <!-- è½®æ’­å›¾ç®¡ç† -->
        <div id="banners-section" class="card">
      <div class="card-header">
        <div class="card-title">è½®æ’­å›¾åˆ—è¡¨</div>
        <button class="btn btn-primary" onclick="openBannerModal()">+ æ–°å¢è½®æ’­å›¾</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>æ ‡é¢˜</th>
            <th>æè¿°</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="banners-list"></tbody>
      </table>
    </div>
    
    <!-- å…¬å‘Šç®¡ç† -->
    <div id="announcements-section" class="card" style="display:none;">
      <div class="card-header">
        <div class="card-title">å…¬å‘Šåˆ—è¡¨</div>
        <button class="btn btn-primary" onclick="openAnnouncementModal()">+ æ–°å¢å…¬å‘Š</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>æ ‡é¢˜</th>
            <th>å†…å®¹</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="announcements-list"></tbody>
      </table>
    </div>
    
    <!-- ä»»åŠ¡ç®¡ç† -->
    <div id="tasks-section" class="card" style="display:none;">
      <div class="card-header">
        <div class="card-title">ä»»åŠ¡åˆ—è¡¨</div>
        <button class="btn btn-primary" onclick="openTaskModal()">+ æ–°å»ºä»»åŠ¡</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>æ ‡é¢˜</th>
            <th>ç±»å‹</th>
            <th>ä»·æ ¼</th>
            <th>ä½ç½®</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tasks-list"></tbody>
      </table>
    </div>
    
    <!-- æˆ‘å‘çš„å•ç®¡ç† -->
    <div id="myTasks-section" class="card" style="display:none;">
      <div class="card-header">
        <div class="card-title">æˆ‘å‘çš„å• - æ¥å•ç»Ÿè®¡</div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ä»»åŠ¡æ ‡é¢˜</th>
            <th>ç±»å‹</th>
            <th>éœ€æ±‚äººæ•°</th>
            <th>æ¥å•äººæ•°</th>
            <th>å¾…å®¡æ ¸</th>
            <th>å·²é€šè¿‡</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="myTasks-list"></tbody>
      </table>
    </div>
  </div>
  
  <!-- è½®æ’­å›¾å¼¹çª— -->
  <div id="banner-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="banner-modal-title">æ–°å¢è½®æ’­å›¾</div>
        <button class="modal-close" onclick="closeBannerModal()">&times;</button>
      </div>
      <form id="banner-form">
        <input type="hidden" id="banner-id">
        <div class="form-group">
          <label class="form-label">æ ‡é¢˜</label>
          <input type="text" class="form-input" id="banner-title" required>
        </div>
        <div class="form-group">
          <label class="form-label">æè¿°</label>
          <input type="text" class="form-input" id="banner-desc">
        </div>
        <div class="form-group">
          <label class="form-label">è½®æ’­å›¾ç‰‡</label>
          <div class="upload-area" id="upload-area" onclick="document.getElementById('banner-file').click()">
            <input type="file" id="banner-file" accept="image/*" style="display:none" onchange="uploadImage(this)">
            <img id="banner-preview" src="" style="display:none; max-width:100%; max-height:150px; border-radius:6px;">
            <div id="upload-placeholder">
              <div style="font-size:32px; color:#999;">ğŸ“·</div>
              <div style="color:#999; font-size:13px; margin-top:8px;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
            </div>
          </div>
          <input type="hidden" id="banner-image">
        </div>
        <div class="form-group">
          <label class="form-label">è·³è½¬é“¾æ¥</label>
          <input type="text" class="form-input" id="banner-link" placeholder="å¯é€‰">
        </div>
        <div class="form-actions">
          <button type="button" class="btn" onclick="closeBannerModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- å…¬å‘Šå¼¹çª— -->
  <div id="announcement-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="announcement-modal-title">æ–°å¢å…¬å‘Š</div>
        <button class="modal-close" onclick="closeAnnouncementModal()">&times;</button>
      </div>
      <form id="announcement-form">
        <input type="hidden" id="announcement-id">
        <div class="form-group">
          <label class="form-label">æ ‡é¢˜</label>
          <input type="text" class="form-input" id="announcement-title" required>
        </div>
        <div class="form-group">
          <label class="form-label">å†…å®¹</label>
          <textarea class="form-input" id="announcement-content" required></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" onclick="closeAnnouncementModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ä»»åŠ¡å¼¹çª— -->
  <div id="task-modal" class="modal">
    <div class="modal-content" style="width:600px;">
      <div class="modal-header">
        <div class="modal-title" id="task-modal-title">æ–°å»ºä»»åŠ¡</div>
        <button class="modal-close" onclick="closeTaskModal()">&times;</button>
      </div>
      <form id="task-form">
        <input type="hidden" id="task-id">
        <div style="display:flex;gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">ä»»åŠ¡æ ‡é¢˜</label>
            <input type="text" class="form-input" id="task-title" required>
          </div>
          <div class="form-group" style="width:120px;">
            <label class="form-label">ä»»åŠ¡ç±»å‹</label>
            <select class="form-input" id="task-type">
              <option value="daily">æ—¥ç»“å•</option>
              <option value="bounty">èµé‡‘å•</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ä»»åŠ¡æè¿°</label>
          <textarea class="form-input" id="task-desc" style="min-height:60px;"></textarea>
        </div>
        <div style="display:flex;gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">å•ä»·</label>
            <input type="number" class="form-input" id="task-price" value="10" min="0">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">å•ä½</label>
            <input type="text" class="form-input" id="task-unit" value="å…ƒ/å•">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">éœ€æ±‚äººæ•°</label>
            <input type="number" class="form-input" id="task-people" value="10" min="1">
          </div>
        </div>
        <div style="display:flex;gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">å·¥ä½œä½ç½®</label>
            <select class="form-input" id="task-location">
              <option value="çº¿ä¸Š">çº¿ä¸Š</option>
              <option value="çº¿ä¸‹">çº¿ä¸‹</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">æ ‡ç­¾</label>
            <input type="text" class="form-input" id="task-tag" placeholder="å¦‚ï¼šçƒ­é—¨ã€ç²¾é€‰">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-input" id="task-status">
              <option value="open">å¼€æ”¾æ¥å•</option>
              <option value="closed">å·²å…³é—­</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">å·¥ä½œæ—¥æœŸ</label>
            <input type="text" class="form-input" id="task-date" placeholder="å¦‚ï¼šä»Šæ—¥ç»“ç®—ã€2025-12-15">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">å·¥ä½œæ—¶é—´</label>
            <input type="text" class="form-input" id="task-period" placeholder="å¦‚ï¼š09:00-18:00">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" onclick="closeTaskModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    
    // ========== ç™»å½•ç›¸å…³ ==========
    function checkLogin() {
      const token = localStorage.getItem('admin_token');
      const user = localStorage.getItem('admin_user');
      if (token && user) {
        document.getElementById('login-page').classList.add('hide');
        document.getElementById('main-page').classList.add('show');
        document.getElementById('admin-name').textContent = JSON.parse(user).nickname;
        loadBanners();
        loadAnnouncements();
      }
    }
    
    document.getElementById('login-form').onsubmit = async (e) => {
      e.preventDefault();
      const phone = document.getElementById('login-phone').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const res = await fetch(API_BASE + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, password })
        }).then(r => r.json());
        
        if (res.code === 0 && res.data.user.role === 'ç®¡ç†å‘˜') {
          localStorage.setItem('admin_token', res.data.token);
          localStorage.setItem('admin_user', JSON.stringify(res.data.user));
          document.getElementById('login-error').style.display = 'none';
          checkLogin();
        } else if (res.code === 0) {
          document.getElementById('login-error').textContent = 'è¯¥è´¦å·æ²¡æœ‰ç®¡ç†å‘˜æƒé™';
          document.getElementById('login-error').style.display = 'block';
        } else {
          document.getElementById('login-error').textContent = res.message || 'ç™»å½•å¤±è´¥';
          document.getElementById('login-error').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('login-error').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        document.getElementById('login-error').style.display = 'block';
      }
    };
    
    function logout() {
      localStorage.removeItem('admin_token');
      localStorage.removeItem('admin_user');
      document.getElementById('login-page').classList.remove('hide');
      document.getElementById('main-page').classList.remove('show');
      document.getElementById('login-phone').value = '';
      document.getElementById('login-password').value = '';
    }
    
    // åˆ‡æ¢èœå•
    function switchMenu(menu, el) {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('banners-section').style.display = menu === 'banners' ? 'block' : 'none';
      document.getElementById('announcements-section').style.display = menu === 'announcements' ? 'block' : 'none';
      document.getElementById('tasks-section').style.display = menu === 'tasks' ? 'block' : 'none';
      document.getElementById('myTasks-section').style.display = menu === 'myTasks' ? 'block' : 'none';
      const titles = { banners: 'è½®æ’­å›¾ç®¡ç†', announcements: 'å…¬å‘Šç®¡ç†', tasks: 'ä»»åŠ¡ç®¡ç†', myTasks: 'æˆ‘å‘çš„å•' };
      document.getElementById('page-title').textContent = titles[menu] || '';
      if (menu === 'tasks') loadTasks();
      if (menu === 'myTasks') loadMyTasks();
    }
    
    // ========== å›¾ç‰‡ä¸Šä¼  ==========
    async function uploadImage(input) {
      if (!input.files || !input.files[0]) return;
      const formData = new FormData();
      formData.append('file', input.files[0]);
      try {
        const res = await fetch(API_BASE + '/upload', { method: 'POST', body: formData }).then(r => r.json());
        if (res.code === 0) {
          document.getElementById('banner-image').value = res.data.url;
          document.getElementById('banner-preview').src = res.data.url;
          document.getElementById('banner-preview').style.display = 'block';
          document.getElementById('upload-placeholder').style.display = 'none';
        } else {
          alert(res.message || 'ä¸Šä¼ å¤±è´¥');
        }
      } catch (err) {
        alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // ========== è½®æ’­å›¾ ==========
    async function loadBanners() {
      const res = await fetch(API_BASE + '/banners').then(r => r.json());
      const list = document.getElementById('banners-list');
      if (res.code === 0 && res.data.length > 0) {
        list.innerHTML = res.data.map(item => `
          <tr>
            <td>${item.title}</td>
            <td>${item.desc || '-'}</td>
            <td><span class="status status-${item.status}">${item.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}</span></td>
            <td class="actions">
              <button class="btn btn-sm" onclick="editBanner('${item.id}')">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" onclick="deleteBanner('${item.id}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
      } else {
        list.innerHTML = '<tr><td colspan="4" class="empty">æš‚æ— è½®æ’­å›¾</td></tr>';
      }
    }
    
    let bannersCache = [];
    async function loadBannersCache() {
      const res = await fetch(API_BASE + '/banners').then(r => r.json());
      bannersCache = res.code === 0 ? res.data : [];
    }
    
    function openBannerModal(data = null) {
      document.getElementById('banner-modal-title').textContent = data ? 'ç¼–è¾‘è½®æ’­å›¾' : 'æ–°å¢è½®æ’­å›¾';
      document.getElementById('banner-id').value = data?.id || '';
      document.getElementById('banner-title').value = data?.title || '';
      document.getElementById('banner-desc').value = data?.desc || '';
      document.getElementById('banner-image').value = data?.imageUrl || '';
      document.getElementById('banner-link').value = data?.link || '';
      document.getElementById('banner-file').value = '';
      // æ˜¾ç¤º/éšè—å›¾ç‰‡é¢„è§ˆ
      if (data?.imageUrl) {
        document.getElementById('banner-preview').src = data.imageUrl;
        document.getElementById('banner-preview').style.display = 'block';
        document.getElementById('upload-placeholder').style.display = 'none';
      } else {
        document.getElementById('banner-preview').style.display = 'none';
        document.getElementById('upload-placeholder').style.display = 'flex';
      }
      document.getElementById('banner-modal').classList.add('show');
    }
    
    function closeBannerModal() {
      document.getElementById('banner-modal').classList.remove('show');
    }
    
    async function editBanner(id) {
      await loadBannersCache();
      const item = bannersCache.find(b => b.id === id);
      if (item) openBannerModal(item);
    }
    
    async function deleteBanner(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè½®æ’­å›¾å—ï¼Ÿ')) return;
      await fetch(API_BASE + '/banners/' + id, { method: 'DELETE' });
      loadBanners();
    }
    
    document.getElementById('banner-form').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('banner-id').value;
      const data = {
        title: document.getElementById('banner-title').value,
        desc: document.getElementById('banner-desc').value,
        imageUrl: document.getElementById('banner-image').value,
        link: document.getElementById('banner-link').value,
        status: 'published'
      };
      if (id) {
        await fetch(API_BASE + '/banners/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      } else {
        await fetch(API_BASE + '/banners', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      }
      closeBannerModal();
      loadBanners();
    };
    
    // ========== å…¬å‘Š ==========
    async function loadAnnouncements() {
      const res = await fetch(API_BASE + '/announcements').then(r => r.json());
      const list = document.getElementById('announcements-list');
      if (res.code === 0 && res.data.length > 0) {
        list.innerHTML = res.data.map(item => `
          <tr>
            <td>${item.title}</td>
            <td>${(item.content || '').substring(0, 30)}${item.content?.length > 30 ? '...' : ''}</td>
            <td><span class="status status-${item.status}">${item.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}</span></td>
            <td class="actions">
              <button class="btn btn-sm" onclick="editAnnouncement('${item.id}')">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement('${item.id}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
      } else {
        list.innerHTML = '<tr><td colspan="4" class="empty">æš‚æ— å…¬å‘Š</td></tr>';
      }
    }
    
    let announcementsCache = [];
    async function loadAnnouncementsCache() {
      const res = await fetch(API_BASE + '/announcements').then(r => r.json());
      announcementsCache = res.code === 0 ? res.data : [];
    }
    
    function openAnnouncementModal(data = null) {
      document.getElementById('announcement-modal-title').textContent = data ? 'ç¼–è¾‘å…¬å‘Š' : 'æ–°å¢å…¬å‘Š';
      document.getElementById('announcement-id').value = data?.id || '';
      document.getElementById('announcement-title').value = data?.title || '';
      document.getElementById('announcement-content').value = data?.content || '';
      document.getElementById('announcement-modal').classList.add('show');
    }
    
    function closeAnnouncementModal() {
      document.getElementById('announcement-modal').classList.remove('show');
    }
    
    async function editAnnouncement(id) {
      await loadAnnouncementsCache();
      const item = announcementsCache.find(a => a.id === id);
      if (item) openAnnouncementModal(item);
    }
    
    async function deleteAnnouncement(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…¬å‘Šå—ï¼Ÿ')) return;
      await fetch(API_BASE + '/announcements/' + id, { method: 'DELETE' });
      loadAnnouncements();
    }
    
    document.getElementById('announcement-form').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('announcement-id').value;
      const data = {
        title: document.getElementById('announcement-title').value,
        content: document.getElementById('announcement-content').value,
        status: 'published'
      };
      if (id) {
        await fetch(API_BASE + '/announcements/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      } else {
        await fetch(API_BASE + '/announcements', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      }
      closeAnnouncementModal();
      loadAnnouncements();
    };
    
    // ========== ä»»åŠ¡ ==========
    async function loadTasks() {
      const res = await fetch(API_BASE + '/tasks').then(r => r.json());
      const list = document.getElementById('tasks-list');
      if (res.code === 0 && res.data.length > 0) {
        list.innerHTML = res.data.map(item => `
          <tr>
            <td>${item.title}</td>
            <td>${item.type === 'daily' ? 'æ—¥ç»“å•' : 'èµé‡‘å•'}</td>
            <td>Â¥${item.price}${item.unit ? '/' + item.unit.replace('å…ƒ/', '') : ''}</td>
            <td>${item.location || 'çº¿ä¸Š'}</td>
            <td><span class="status ${item.status === 'open' ? 'status-published' : 'status-draft'}">${item.status === 'open' ? 'å¼€æ”¾' : 'å…³é—­'}</span></td>
            <td class="actions">
              <button class="btn btn-sm" onclick="editTask('${item.id}')">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask('${item.id}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
      } else {
        list.innerHTML = '<tr><td colspan="6" class="empty">æš‚æ— ä»»åŠ¡</td></tr>';
      }
    }
    
    let tasksCache = [];
    async function loadTasksCache() {
      const res = await fetch(API_BASE + '/tasks').then(r => r.json());
      tasksCache = res.code === 0 ? res.data : [];
    }
    
    function openTaskModal(data = null) {
      document.getElementById('task-modal-title').textContent = data ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ–°å»ºä»»åŠ¡';
      document.getElementById('task-id').value = data?.id || '';
      document.getElementById('task-title').value = data?.title || '';
      document.getElementById('task-desc').value = data?.desc || '';
      document.getElementById('task-type').value = data?.type || 'daily';
      document.getElementById('task-price').value = data?.price || 10;
      document.getElementById('task-unit').value = data?.unit || 'å…ƒ/å•';
      document.getElementById('task-people').value = data?.peopleNeeded || 10;
      document.getElementById('task-location').value = data?.location || 'çº¿ä¸Š';
      document.getElementById('task-tag').value = data?.tag || '';
      document.getElementById('task-status').value = data?.status || 'open';
      document.getElementById('task-date').value = data?.date || '';
      document.getElementById('task-period').value = data?.period || '';
      document.getElementById('task-modal').classList.add('show');
    }
    
    function closeTaskModal() {
      document.getElementById('task-modal').classList.remove('show');
    }
    
    async function editTask(id) {
      await loadTasksCache();
      const item = tasksCache.find(t => t.id === id);
      if (item) openTaskModal(item);
    }
    
    async function deleteTask(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
      await fetch(API_BASE + '/tasks/' + id, { method: 'DELETE' });
      loadTasks();
    }
    
    document.getElementById('task-form').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('task-id').value;
      const adminUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
      const data = {
        title: document.getElementById('task-title').value,
        desc: document.getElementById('task-desc').value,
        type: document.getElementById('task-type').value,
        price: parseFloat(document.getElementById('task-price').value) || 0,
        unit: document.getElementById('task-unit').value,
        peopleNeeded: parseInt(document.getElementById('task-people').value) || 10,
        location: document.getElementById('task-location').value,
        tag: document.getElementById('task-tag').value,
        status: document.getElementById('task-status').value,
        date: document.getElementById('task-date').value,
        period: document.getElementById('task-period').value,
        publisher: adminUser.nickname || 'ç®¡ç†å‘˜',
        publisherId: adminUser.id || null
      };
      if (id) {
        await fetch(API_BASE + '/tasks/' + id, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      } else {
        await fetch(API_BASE + '/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
      }
      closeTaskModal();
      loadTasks();
    };
    
    // ========== æˆ‘å‘çš„å•ç®¡ç† ==========
    async function loadMyTasks() {
      const res = await fetch(API_BASE + '/tasks/published/stats').then(r => r.json());
      const list = document.getElementById('myTasks-list');
      if (res.code === 0 && res.data.length > 0) {
        list.innerHTML = res.data.map(item => `
          <tr>
            <td>${item.title}</td>
            <td>${item.type === 'daily' ? 'æ—¥ç»“å•' : 'èµé‡‘å•'}</td>
            <td>${item.peopleNeeded}</td>
            <td><strong>${item.orderCount}</strong></td>
            <td><span style="color:#fa8c16;">${item.submittedCount}</span></td>
            <td><span style="color:#52c41a;">${item.approvedCount}</span></td>
            <td><span class="status ${item.status === 'open' ? 'status-published' : 'status-draft'}">${item.status === 'open' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span></td>
            <td class="actions">
              <button class="btn btn-sm" onclick="viewOrders('${item.id}', '${item.title}')">æŸ¥çœ‹æ¥å•</button>
              ${item.status === 'open' ? `<button class="btn btn-sm btn-danger" onclick="closeTask('${item.id}')">ç»“æŸ</button>` : ''}
            </td>
          </tr>
        `).join('');
      } else {
        list.innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— å‘å¸ƒçš„ä»»åŠ¡</td></tr>';
      }
    }
    
    async function closeTask(id) {
      if (!confirm('ç¡®å®šè¦ç»“æŸè¿™ä¸ªä»»åŠ¡å—ï¼Ÿç»“æŸåå°†ä¸å†æ¥å—æ–°çš„æ¥å•ã€‚')) return;
      await fetch(API_BASE + '/tasks/' + id + '/close', { method: 'PATCH' });
      loadMyTasks();
    }
    
    async function viewOrders(taskId, taskTitle) {
      const res = await fetch(API_BASE + '/tasks/' + taskId + '/orders').then(r => r.json());
      if (res.code === 0) {
        let html = `<h3 style="margin-bottom:15px;">ã€${taskTitle}ã€‘æ¥å•è¯¦æƒ…</h3>`;
        if (res.data.length > 0) {
          html += '<table style="width:100%;"><thead><tr><th>ç”¨æˆ·</th><th>çŠ¶æ€</th><th>æ¥å•æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
          html += res.data.map(o => `
            <tr>
              <td>${o.userName || o.userId}</td>
              <td><span class="status ${o.status === 'approved' ? 'status-published' : o.status === 'rejected' ? 'status-draft' : ''}">${getOrderStatusText(o.status)}</span></td>
              <td>${o.createdAt ? new Date(o.createdAt).toLocaleString() : '-'}</td>
              <td class="actions">
                ${o.status === 'submitted' ? `
                  <button class="btn btn-sm btn-primary" onclick="reviewOrder('${o.id}', 'approved')">é€šè¿‡</button>
                  <button class="btn btn-sm btn-danger" onclick="reviewOrder('${o.id}', 'rejected')">æ‹’ç»</button>
                ` : '-'}
              </td>
            </tr>
          `).join('');
          html += '</tbody></table>';
        } else {
          html += '<p style="color:#999;text-align:center;padding:30px;">æš‚æ— æ¥å•è®°å½•</p>';
        }
        showOrdersModal(html);
      }
    }
    
    function getOrderStatusText(status) {
      const map = { pending: 'è¿›è¡Œä¸­', submitted: 'å¾…å®¡æ ¸', approved: 'å·²é€šè¿‡', rejected: 'å·²æ‹’ç»' };
      return map[status] || status;
    }
    
    async function reviewOrder(orderId, status) {
      await fetch(API_BASE + '/orders/' + orderId + '/review', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status })
      });
      document.getElementById('orders-modal').classList.remove('show');
      loadMyTasks();
      alert(status === 'approved' ? 'å·²é€šè¿‡å®¡æ ¸' : 'å·²æ‹’ç»');
    }
    
    function showOrdersModal(html) {
      let modal = document.getElementById('orders-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'orders-modal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content" style="width:700px;max-height:80vh;overflow-y:auto;">
          <div class="modal-header">
            <div class="modal-title">æ¥å•è¯¦æƒ…</div>
            <button class="modal-close" onclick="document.getElementById('orders-modal').classList.remove('show')">&times;</button>
          </div>
          <div id="orders-content"></div>
        </div>`;
        document.body.appendChild(modal);
      }
      document.getElementById('orders-content').innerHTML = html;
      modal.classList.add('show');
    }
    
    // åˆå§‹åŒ– - æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLogin();
  </script>
</body>
</html>
