<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>团餐管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .sidebar { width: 220px; }
    .main-content { margin-left: 220px; }
    .menu-item.active { background: linear-gradient(135deg, #4CD964 0%, #5AC8FA 100%); color: white; }
    .menu-item:hover { background: #f0f9f4; }
    .menu-item.active:hover { background: linear-gradient(135deg, #4CD964 0%, #5AC8FA 100%); }
    .btn-primary { background: linear-gradient(135deg, #4CD964 0%, #5AC8FA 100%); }
    .btn-primary:hover { opacity: 0.9; }
    .status-on { background: #d1fae5; color: #059669; }
    .status-off { background: #fee2e2; color: #dc2626; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app">
    <!-- 登录页面 -->
    <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center">
      <div class="bg-white rounded-xl shadow-lg p-8 w-96">
        <div class="text-center mb-8">
          <i class="fas fa-utensils text-5xl text-green-500 mb-4"></i>
          <h1 class="text-2xl font-bold text-gray-800">团餐管理系统</h1>
          <p class="text-gray-500 mt-2">管理员登录</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">手机号</label>
          <div class="relative">
            <i class="fas fa-phone absolute left-3 top-3 text-gray-400"></i>
            <input v-model="loginForm.phone" type="text" placeholder="请输入手机号" 
              class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
          </div>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
          <div class="relative">
            <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
            <input v-model="loginForm.password" type="password" placeholder="请输入密码" 
              class="w-full border rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500"
              @keyup.enter="handleLogin">
          </div>
        </div>
        <button @click="handleLogin" :disabled="loginLoading" 
          class="w-full btn-primary text-white py-3 rounded-lg font-medium flex items-center justify-center">
          <i v-if="loginLoading" class="fas fa-spinner fa-spin mr-2"></i>
          {{ loginLoading ? '登录中...' : '登 录' }}
        </button>
        <p v-if="loginError" class="text-red-500 text-sm text-center mt-4">{{ loginError }}</p>
      </div>
    </div>

    <!-- 管理页面（登录后显示） -->
    <template v-else>
    <!-- 侧边栏 -->
    <aside class="sidebar fixed left-0 top-0 h-full bg-white shadow-lg z-10">
      <div class="p-4 border-b">
        <h1 class="text-xl font-bold text-green-600">
          <i class="fas fa-utensils mr-2"></i>团餐管理
        </h1>
      </div>
      <nav class="p-4">
        <div class="menu-item flex items-center p-3 rounded-lg cursor-pointer mb-2" :class="{active: currentPage === 'dishes'}" @click="currentPage = 'dishes'">
          <i class="fas fa-hamburger w-6"></i>
          <span>菜品管理</span>
        </div>
        <div class="menu-item flex items-center p-3 rounded-lg cursor-pointer mb-2" :class="{active: currentPage === 'banners'}" @click="currentPage = 'banners'">
          <i class="fas fa-images w-6"></i>
          <span>轮播管理</span>
        </div>
        <div class="menu-item flex items-center p-3 rounded-lg cursor-pointer mb-2" :class="{active: currentPage === 'notices'}" @click="currentPage = 'notices'">
          <i class="fas fa-bullhorn w-6"></i>
          <span>公告管理</span>
        </div>
        <div class="menu-item flex items-center p-3 rounded-lg cursor-pointer mb-2" :class="{active: currentPage === 'categories'}" @click="currentPage = 'categories'">
          <i class="fas fa-tags w-6"></i>
          <span>分类管理</span>
        </div>
        <div class="border-t mt-4 pt-4">
          <div class="text-xs text-gray-400 mb-2 px-3">当前账号</div>
          <div class="px-3 text-sm text-gray-600 mb-3">{{ adminPhone }}</div>
          <div class="menu-item flex items-center p-3 rounded-lg cursor-pointer text-red-500 hover:bg-red-50" @click="handleLogout">
            <i class="fas fa-sign-out-alt w-6"></i>
            <span>退出登录</span>
          </div>
        </div>
      </nav>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content min-h-screen p-6">
      <!-- 菜品管理 -->
      <div v-if="currentPage === 'dishes'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">菜品管理</h2>
          <button class="btn-primary text-white px-4 py-2 rounded-lg" @click="openDishModal()">
            <i class="fas fa-plus mr-2"></i>新增菜品
          </button>
        </div>
        
        <!-- 搜索栏 -->
        <div class="bg-white rounded-lg p-4 mb-4 flex gap-4">
          <input v-model="dishSearch" type="text" placeholder="搜索菜品名称" class="border rounded-lg px-3 py-2 w-64">
          <select v-model="dishCategoryFilter" class="border rounded-lg px-3 py-2">
            <option value="">全部分类</option>
            <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{cat.name}}</option>
          </select>
          <button class="bg-gray-500 text-white px-4 py-2 rounded-lg" @click="loadDishes">搜索</button>
        </div>

        <!-- 菜品列表 -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left">图片</th>
                <th class="px-4 py-3 text-left">名称</th>
                <th class="px-4 py-3 text-left">价格</th>
                <th class="px-4 py-3 text-left">分类</th>
                <th class="px-4 py-3 text-left">餐次</th>
                <th class="px-4 py-3 text-left">库存</th>
                <th class="px-4 py-3 text-left">状态</th>
                <th class="px-4 py-3 text-left">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="dish in dishes" :key="dish.id" class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">
                  <img :src="dish.image || '/uploads/placeholder.png'" class="w-12 h-12 rounded object-cover">
                </td>
                <td class="px-4 py-3">
                  <div>{{dish.name}}</div>
                  <div class="text-xs text-gray-400" v-if="dish.is_special">
                    <span class="bg-red-100 text-red-600 px-1 rounded">特价</span>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <span class="text-red-500 font-bold">¥{{dish.price}}</span>
                  <span v-if="dish.original_price > dish.price" class="text-gray-400 line-through text-sm ml-1">¥{{dish.original_price}}</span>
                </td>
                <td class="px-4 py-3">{{getCategoryName(dish.category_id)}}</td>
                <td class="px-4 py-3">{{getMealTimeName(dish.meal_time)}}</td>
                <td class="px-4 py-3">{{dish.stock}}</td>
                <td class="px-4 py-3">
                  <span :class="dish.status === 1 ? 'status-on' : 'status-off'" class="px-2 py-1 rounded text-sm">
                    {{dish.status === 1 ? '上架' : '下架'}}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <button class="text-blue-500 mr-2" @click="openDishModal(dish)">编辑</button>
                  <button class="text-orange-500 mr-2" @click="toggleDishStatus(dish)">{{dish.status === 1 ? '下架' : '上架'}}</button>
                  <button class="text-red-500" @click="deleteDish(dish)">删除</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 轮播管理 -->
      <div v-if="currentPage === 'banners'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">轮播管理</h2>
          <button class="btn-primary text-white px-4 py-2 rounded-lg" @click="openBannerModal()">
            <i class="fas fa-plus mr-2"></i>新增轮播
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="banner in banners" :key="banner.id" class="bg-white rounded-lg shadow overflow-hidden">
            <img :src="banner.image" class="w-full h-40 object-cover">
            <div class="p-4">
              <h3 class="font-bold">{{banner.title}}</h3>
              <p class="text-gray-500 text-sm">{{banner.subtitle}}</p>
              <div class="mt-3 flex justify-between items-center">
                <span :class="banner.status === 1 ? 'status-on' : 'status-off'" class="px-2 py-1 rounded text-sm">
                  {{banner.status === 1 ? '显示' : '隐藏'}}
                </span>
                <div>
                  <button class="text-blue-500 mr-2" @click="openBannerModal(banner)">编辑</button>
                  <button class="text-red-500" @click="deleteBanner(banner)">删除</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 公告管理 -->
      <div v-if="currentPage === 'notices'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">公告管理</h2>
          <button class="btn-primary text-white px-4 py-2 rounded-lg" @click="openNoticeModal()">
            <i class="fas fa-plus mr-2"></i>新增公告
          </button>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left">标题</th>
                <th class="px-4 py-3 text-left">类型</th>
                <th class="px-4 py-3 text-left">内容预览</th>
                <th class="px-4 py-3 text-left">状态</th>
                <th class="px-4 py-3 text-left">创建时间</th>
                <th class="px-4 py-3 text-left">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="notice in notices" :key="notice.id" class="border-t hover:bg-gray-50">
                <td class="px-4 py-3 font-medium">{{notice.title}}</td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded text-sm" :class="getNoticeTypeClass(notice.type)">
                    {{getNoticeTypeName(notice.type)}}
                  </span>
                </td>
                <td class="px-4 py-3 text-gray-500 truncate max-w-xs">{{notice.content}}</td>
                <td class="px-4 py-3">
                  <span :class="notice.status === 1 ? 'status-on' : 'status-off'" class="px-2 py-1 rounded text-sm">
                    {{notice.status === 1 ? '已发布' : '已下线'}}
                  </span>
                </td>
                <td class="px-4 py-3 text-gray-500">{{notice.created_at}}</td>
                <td class="px-4 py-3">
                  <button class="text-blue-500 mr-2" @click="openNoticeModal(notice)">编辑</button>
                  <button class="text-orange-500 mr-2" @click="toggleNoticeStatus(notice)">{{notice.status === 1 ? '下线' : '发布'}}</button>
                  <button class="text-red-500" @click="deleteNotice(notice)">删除</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 分类管理 -->
      <div v-if="currentPage === 'categories'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">分类管理</h2>
          <button class="btn-primary text-white px-4 py-2 rounded-lg" @click="openCategoryModal()">
            <i class="fas fa-plus mr-2"></i>新增分类
          </button>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left">ID</th>
                <th class="px-4 py-3 text-left">分类名称</th>
                <th class="px-4 py-3 text-left">排序</th>
                <th class="px-4 py-3 text-left">状态</th>
                <th class="px-4 py-3 text-left">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cat in categories" :key="cat.id" class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">{{cat.id}}</td>
                <td class="px-4 py-3 font-medium">{{cat.name}}</td>
                <td class="px-4 py-3">{{cat.sort}}</td>
                <td class="px-4 py-3">
                  <span :class="cat.status === 1 ? 'status-on' : 'status-off'" class="px-2 py-1 rounded text-sm">
                    {{cat.status === 1 ? '启用' : '禁用'}}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <button class="text-blue-500 mr-2" @click="openCategoryModal(cat)">编辑</button>
                  <button class="text-red-500" @click="deleteCategory(cat)">删除</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- 菜品弹窗 -->
    <div v-if="showDishModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-2xl max-h-screen overflow-y-auto">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-lg font-bold">{{dishForm.id ? '编辑菜品' : '新增菜品'}}</h3>
          <button @click="showDishModal = false" class="text-gray-500">&times;</button>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">菜品名称 *</label>
              <input v-model="dishForm.name" type="text" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">分类</label>
              <select v-model="dishForm.category_id" class="w-full border rounded-lg px-3 py-2">
                <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{cat.name}}</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">售价 *</label>
              <input v-model.number="dishForm.price" type="number" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">原价</label>
              <input v-model.number="dishForm.original_price" type="number" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">库存</label>
              <input v-model.number="dishForm.stock" type="number" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">单位</label>
              <input v-model="dishForm.unit" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="份">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">餐次</label>
              <select v-model="dishForm.meal_time" class="w-full border rounded-lg px-3 py-2">
                <option value="breakfast">早餐</option>
                <option value="lunch">午餐</option>
                <option value="dinner">晚餐</option>
                <option value="tea">下午茶</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">状态</label>
              <select v-model.number="dishForm.status" class="w-full border rounded-lg px-3 py-2">
                <option :value="1">上架</option>
                <option :value="0">下架</option>
              </select>
            </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">图片</label>
            <div class="flex items-center gap-2 mb-2">
              <input v-model="dishForm.image" type="text" class="flex-1 border rounded-lg px-3 py-2" placeholder="输入图片地址或上传">
              <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg border">
                <i class="fas fa-upload mr-2"></i>上传
                <input type="file" class="hidden" accept="image/*" @change="handleImageUpload($event, 'dish')">
              </label>
            </div>
            <div v-if="dishForm.image" class="w-24 h-24 border rounded-lg overflow-hidden bg-gray-50">
              <img :src="dishForm.image" class="w-full h-full object-cover">
            </div>
          </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium mb-1">描述</label>
              <textarea v-model="dishForm.description" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
            </div>
            <div class="col-span-2">
              <label class="flex items-center">
                <input type="checkbox" v-model="dishForm.is_special" :true-value="1" :false-value="0" class="mr-2">
                设为特价商品
              </label>
            </div>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button @click="showDishModal = false" class="px-4 py-2 border rounded-lg">取消</button>
            <button @click="saveDish" class="btn-primary text-white px-4 py-2 rounded-lg">保存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 轮播弹窗 -->
    <div v-if="showBannerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-lg">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-lg font-bold">{{bannerForm.id ? '编辑轮播' : '新增轮播'}}</h3>
          <button @click="showBannerModal = false" class="text-gray-500">&times;</button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">图片 *</label>
            <div class="flex items-center gap-2 mb-2">
              <input v-model="bannerForm.image" type="text" class="flex-1 border rounded-lg px-3 py-2" placeholder="输入图片地址或上传">
              <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg border">
                <i class="fas fa-upload mr-2"></i>上传
                <input type="file" class="hidden" accept="image/*" @change="handleImageUpload($event, 'banner')">
              </label>
            </div>
            <div v-if="bannerForm.image" class="w-full h-40 border rounded-lg overflow-hidden bg-gray-50">
              <img :src="bannerForm.image" class="w-full h-full object-cover">
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">标题</label>
            <input v-model="bannerForm.title" type="text" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">副标题</label>
            <input v-model="bannerForm.subtitle" type="text" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">跳转链接</label>
            <input v-model="bannerForm.link" type="text" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-1">排序</label>
              <input v-model.number="bannerForm.sort" type="number" class="w-full border rounded-lg px-3 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">状态</label>
              <select v-model.number="bannerForm.status" class="w-full border rounded-lg px-3 py-2">
                <option :value="1">显示</option>
                <option :value="0">隐藏</option>
              </select>
            </div>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button @click="showBannerModal = false" class="px-4 py-2 border rounded-lg">取消</button>
            <button @click="saveBanner" class="btn-primary text-white px-4 py-2 rounded-lg">保存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 公告弹窗 -->
    <div v-if="showNoticeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-lg">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-lg font-bold">{{noticeForm.id ? '编辑公告' : '新增公告'}}</h3>
          <button @click="showNoticeModal = false" class="text-gray-500">&times;</button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">标题 *</label>
            <input v-model="noticeForm.title" type="text" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">类型</label>
            <select v-model="noticeForm.type" class="w-full border rounded-lg px-3 py-2">
              <option value="notice">通知</option>
              <option value="activity">活动</option>
              <option value="system">系统</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">内容</label>
            <textarea v-model="noticeForm.content" rows="5" class="w-full border rounded-lg px-3 py-2"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">状态</label>
            <select v-model.number="noticeForm.status" class="w-full border rounded-lg px-3 py-2">
              <option :value="1">发布</option>
              <option :value="0">下线</option>
            </select>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button @click="showNoticeModal = false" class="px-4 py-2 border rounded-lg">取消</button>
            <button @click="saveNotice" class="btn-primary text-white px-4 py-2 rounded-lg">保存</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 分类弹窗 -->
    <div v-if="showCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-md">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-lg font-bold">{{categoryForm.id ? '编辑分类' : '新增分类'}}</h3>
          <button @click="showCategoryModal = false" class="text-gray-500">&times;</button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">分类名称 *</label>
            <input v-model="categoryForm.name" type="text" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">排序</label>
            <input v-model.number="categoryForm.sort" type="number" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">状态</label>
            <select v-model.number="categoryForm.status" class="w-full border rounded-lg px-3 py-2">
              <option :value="1">启用</option>
              <option :value="0">禁用</option>
            </select>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button @click="showCategoryModal = false" class="px-4 py-2 border rounded-lg">取消</button>
            <button @click="saveCategory" class="btn-primary text-white px-4 py-2 rounded-lg">保存</button>
          </div>
        </div>
      </div>
    </div>
    </template>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
  <script>
    const { createApp, ref, onMounted } = Vue;
    
    createApp({
      setup() {
        const API_BASE = '';
        
        // 登录相关
        const isLoggedIn = ref(false);
        const adminPhone = ref('');
        const loginForm = ref({ phone: '', password: '' });
        const loginLoading = ref(false);
        const loginError = ref('');
        const authToken = ref('');
        
        // 检查登录状态
        const checkAuth = async () => {
          const token = localStorage.getItem('admin_token');
          if (token) {
            try {
              const res = await axios.get(`${API_BASE}/api/check-auth`, {
                headers: { 'Authorization': token }
              });
              if (res.data.code === 0) {
                authToken.value = token;
                adminPhone.value = res.data.data.phone;
                isLoggedIn.value = true;
                // 设置axios默认header
                axios.defaults.headers.common['Authorization'] = token;
                return true;
              }
            } catch (e) {}
          }
          localStorage.removeItem('admin_token');
          isLoggedIn.value = false;
          return false;
        };
        
        // 登录
        const handleLogin = async () => {
          if (!loginForm.value.phone || !loginForm.value.password) {
            loginError.value = '请输入手机号和密码';
            return;
          }
          loginLoading.value = true;
          loginError.value = '';
          try {
            const res = await axios.post(`${API_BASE}/api/login`, loginForm.value);
            if (res.data.code === 0) {
              const token = res.data.data.token;
              localStorage.setItem('admin_token', token);
              authToken.value = token;
              adminPhone.value = res.data.data.phone;
              axios.defaults.headers.common['Authorization'] = token;
              isLoggedIn.value = true;
              // 加载数据
              loadCategories();
              loadDishes();
              loadBanners();
              loadNotices();
            } else {
              loginError.value = res.data.msg || '登录失败';
            }
          } catch (e) {
            loginError.value = '网络错误，请重试';
          }
          loginLoading.value = false;
        };
        
        // 登出
        const handleLogout = async () => {
          try {
            await axios.post(`${API_BASE}/api/logout`);
          } catch (e) {}
          localStorage.removeItem('admin_token');
          delete axios.defaults.headers.common['Authorization'];
          isLoggedIn.value = false;
          adminPhone.value = '';
          authToken.value = '';
          loginForm.value = { phone: '', password: '' };
        };
        
        const currentPage = ref('dishes');
        
        // 数据
        const dishes = ref([]);
        const banners = ref([]);
        const notices = ref([]);
        const categories = ref([]);
        
        // 搜索
        const dishSearch = ref('');
        const dishCategoryFilter = ref('');
        
        // 弹窗控制
        const showDishModal = ref(false);
        const showBannerModal = ref(false);
        const showNoticeModal = ref(false);
        const showCategoryModal = ref(false);
        
        // 表单
        const dishForm = ref({});
        const bannerForm = ref({});
        const noticeForm = ref({});
        const categoryForm = ref({});
        
        // 加载数据
        const loadDishes = async () => {
          const params = new URLSearchParams();
          if (dishSearch.value) params.append('keyword', dishSearch.value);
          if (dishCategoryFilter.value) params.append('category_id', dishCategoryFilter.value);
          const res = await axios.get(`${API_BASE}/api/dishes?${params}`);
          dishes.value = res.data.data;
        };
        
        const loadBanners = async () => {
          const res = await axios.get(`${API_BASE}/api/banners`);
          banners.value = res.data.data;
        };
        
        const loadNotices = async () => {
          const res = await axios.get(`${API_BASE}/api/notices`);
          notices.value = res.data.data;
        };
        
        const loadCategories = async () => {
          const res = await axios.get(`${API_BASE}/api/categories`);
          categories.value = res.data.data;
        };
        
        // 菜品操作
        const openDishModal = (dish = null) => {
          dishForm.value = dish ? { ...dish } : {
            status: 1,
            stock: 100,
            meal_time: 'lunch',
            unit: '份',
            is_special: 0,
            image: '',
            description: ''
          };
          // 新增时默认选中第一个分类
          if (!dish && categories.value.length > 0) {
            dishForm.value.category_id = categories.value[0].id;
          }
          showDishModal.value = true;
        };
        
        const saveDish = async () => {
          if (!dishForm.value.name || !dishForm.value.price) {
            alert('请填写必要字段');
            return;
          }
          try {
            const payload = {
              ...dishForm.value,
              image: dishForm.value.image ?? '',
              description: dishForm.value.description ?? '',
              unit: dishForm.value.unit ?? '份',
              stock: dishForm.value.stock ?? 100,
              is_special: dishForm.value.is_special ?? 0,
              meal_time: dishForm.value.meal_time ?? 'lunch',
              status: dishForm.value.status ?? 1,
              original_price: (dishForm.value.original_price ?? dishForm.value.price)
            };
            let res;
            if (dishForm.value.id) {
              res = await axios.put(`${API_BASE}/api/dishes/${dishForm.value.id}`, payload);
            } else {
              res = await axios.post(`${API_BASE}/api/dishes`, payload);
            }
            if (res.data.code === 0) {
              showDishModal.value = false;
              loadDishes();
            } else {
              alert(res.data.msg || '保存失败');
            }
          } catch (e) {
            console.error(e);
            alert('保存失败：' + (e.response?.data?.msg || e.message || '网络错误'));
          }
        };
        
        const toggleDishStatus = async (dish) => {
          await axios.put(`${API_BASE}/api/dishes/${dish.id}/status`, { status: dish.status === 1 ? 0 : 1 });
          loadDishes();
        };
        
        const deleteDish = async (dish) => {
          if (confirm(`确认删除「${dish.name}」？`)) {
            await axios.delete(`${API_BASE}/api/dishes/${dish.id}`);
            loadDishes();
          }
        };
        
        // 轮播操作
        const openBannerModal = (banner = null) => {
          bannerForm.value = banner ? { ...banner } : {
            status: 1,
            sort: 0,
            image: '',
            title: '',
            subtitle: '',
            link: ''
          };
          showBannerModal.value = true;
        };
        
        const saveBanner = async () => {
          if (!bannerForm.value.image) {
            alert('请填写图片URL');
            return;
          }
          try {
            const payload = {
              ...bannerForm.value,
              title: bannerForm.value.title ?? '',
              subtitle: bannerForm.value.subtitle ?? '',
              link: bannerForm.value.link ?? '',
              sort: bannerForm.value.sort ?? 0,
              status: bannerForm.value.status ?? 1
            };
            let res;
            if (bannerForm.value.id) {
              res = await axios.put(`${API_BASE}/api/banners/${bannerForm.value.id}`, payload);
            } else {
              res = await axios.post(`${API_BASE}/api/banners`, payload);
            }
            if (res.data.code === 0) {
              showBannerModal.value = false;
              loadBanners();
            } else {
              alert(res.data.msg || '保存失败');
            }
          } catch (e) {
            console.error(e);
            alert('保存失败：' + (e.response?.data?.msg || e.message || '网络错误'));
          }
        };
        
        const deleteBanner = async (banner) => {
          if (confirm('确认删除该轮播？')) {
            await axios.delete(`${API_BASE}/api/banners/${banner.id}`);
            loadBanners();
          }
        };
        
        // 公告操作
        const openNoticeModal = (notice = null) => {
          noticeForm.value = notice ? { ...notice } : {
            status: 1,
            type: 'notice',
            title: '',
            content: ''
          };
          showNoticeModal.value = true;
        };
        
        const saveNotice = async () => {
          if (!noticeForm.value.title) {
            alert('请填写标题');
            return;
          }
          try {
            const payload = {
              ...noticeForm.value,
              content: noticeForm.value.content ?? '',
              type: noticeForm.value.type ?? 'notice',
              status: noticeForm.value.status ?? 1
            };
            let res;
            if (noticeForm.value.id) {
              res = await axios.put(`${API_BASE}/api/notices/${noticeForm.value.id}`, payload);
            } else {
              res = await axios.post(`${API_BASE}/api/notices`, payload);
            }
            if (res.data.code === 0) {
              showNoticeModal.value = false;
              loadNotices();
            } else {
              alert(res.data.msg || '保存失败');
            }
          } catch (e) {
            console.error(e);
            alert('保存失败：' + (e.response?.data?.msg || e.message || '网络错误'));
          }
        };
        
        const toggleNoticeStatus = async (notice) => {
          await axios.put(`${API_BASE}/api/notices/${notice.id}/status`, { status: notice.status === 1 ? 0 : 1 });
          loadNotices();
        };
        
        const deleteNotice = async (notice) => {
          if (confirm(`确认删除「${notice.title}」？`)) {
            await axios.delete(`${API_BASE}/api/notices/${notice.id}`);
            loadNotices();
          }
        };
        
        // 分类操作
        const openCategoryModal = (category = null) => {
          categoryForm.value = category ? { ...category } : { status: 1, sort: 0, name: '' };
          showCategoryModal.value = true;
        };
        
        const saveCategory = async () => {
          if (!categoryForm.value.name) {
            alert('请填写分类名称');
            return;
          }
          try {
            const payload = {
              ...categoryForm.value,
              sort: categoryForm.value.sort ?? 0,
              status: categoryForm.value.status ?? 1
            };
            let res;
            if (categoryForm.value.id) {
              res = await axios.put(`${API_BASE}/api/categories/${categoryForm.value.id}`, payload);
            } else {
              res = await axios.post(`${API_BASE}/api/categories`, payload);
            }
            if (res.data.code === 0) {
              showCategoryModal.value = false;
              loadCategories();
            } else {
              alert(res.data.msg || '保存失败');
            }
          } catch (e) {
            console.error(e);
            alert('保存失败：' + (e.response?.data?.msg || e.message || '网络错误'));
          }
        };
        
        const deleteCategory = async (category) => {
          if (confirm(`确认删除「${category.name}」？`)) {
            await axios.delete(`${API_BASE}/api/categories/${category.id}`);
            loadCategories();
          }
        };
        
        // 图片上传
        const handleImageUpload = async (event, type) => {
          const file = event.target.files[0];
          if (!file) return;
          
          const formData = new FormData();
          formData.append('file', file);
          
          try {
            const res = await axios.post(`${API_BASE}/api/upload`, formData, {
              headers: { 'Content-Type': 'multipart/form-data' }
            });
            if (res.data.code === 0) {
              if (type === 'dish') {
                dishForm.value.image = res.data.data.url;
              } else if (type === 'banner') {
                bannerForm.value.image = res.data.data.url;
              }
            } else {
              alert(res.data.msg || '上传失败');
            }
          } catch (e) {
            alert('上传出错，请重试');
          }
        };

        // 辅助方法
        const getCategoryName = (id) => {
          const cat = categories.value.find(c => c.id === id);
          return cat ? cat.name : '-';
        };
        
        const getMealTimeName = (time) => {
          const map = { breakfast: '早餐', lunch: '午餐', dinner: '晚餐', tea: '下午茶' };
          return map[time] || time;
        };
        
        const getNoticeTypeName = (type) => {
          const map = { notice: '通知', activity: '活动', system: '系统' };
          return map[type] || type;
        };
        
        const getNoticeTypeClass = (type) => {
          const map = { notice: 'bg-blue-100 text-blue-600', activity: 'bg-orange-100 text-orange-600', system: 'bg-gray-100 text-gray-600' };
          return map[type] || '';
        };
        
        onMounted(async () => {
          // 先检查登录状态
          const loggedIn = await checkAuth();
          if (loggedIn) {
            loadCategories();
            loadDishes();
            loadBanners();
            loadNotices();
          }
        });
        
        return {
          // 登录相关
          isLoggedIn, adminPhone, loginForm, loginLoading, loginError,
          handleLogin, handleLogout,
          // 页面相关
          currentPage,
          dishes, banners, notices, categories,
          dishSearch, dishCategoryFilter,
          showDishModal, showBannerModal, showNoticeModal, showCategoryModal,
          dishForm, bannerForm, noticeForm, categoryForm,
          loadDishes, loadBanners, loadNotices, loadCategories,
          openDishModal, saveDish, toggleDishStatus, deleteDish,
          openBannerModal, saveBanner, deleteBanner,
          openNoticeModal, saveNotice, toggleNoticeStatus, deleteNotice,
          openCategoryModal, saveCategory, deleteCategory,
          getCategoryName, getMealTimeName, getNoticeTypeName, getNoticeTypeClass,
          handleImageUpload
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
